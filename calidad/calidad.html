<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Calidad - BlaaFlow</title>
  <link rel="stylesheet" href="../assets/css/layout.css">
  <link rel="stylesheet" href="../assets/css/calidad/calidad.css">

  <style>
    /* === ESTILOS ADAPTADOS PARA CONTROL DE TIEMPO === */
    .time-cell {
      text-align: center;
      min-width: 150px;
    }
    .time-display {
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    .time-btns {
      display: flex;
      justify-content: center;
      gap: 4px;
    }
    .time-btns button {
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 4px 6px;
      font-size: 13px;
      transition: 0.2s;
    }
    .btn-start { background: #009900; color: #fff; }
    .btn-start:hover { background: #00b300; }
    .btn-pause { background: #ffbf00; color: #fff; }
    .btn-pause:hover { background: #ffcc33; }
    .btn-save { background: #007bff; color: #fff; }
    .btn-save:hover { background: #3399ff; }

    .progress-bar {
      height: 4px;
      width: 100%;
      background: #eee;
      border-radius: 3px;
      margin-top: 5px;
      overflow: hidden;
    }
    .progress-inner {
      height: 100%;
      width: 0%;
      background: #28a745;
      transition: width 1s linear;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <img src="../assets/img/logo-sin-fondo.png" alt="Logo BlaaFlow">
    <div class="search-profile">
      <input type="text" placeholder="Buscar...">
      <div class="profile">A</div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <ul>
      <li><a href="../dashboard.html">Dashboard Admin</a></li>

      <div class="section-title"><b>Fases Especializadas ‚ñø</b></div>
      <li><a href="../empaste/empaste.html">Encuadernaci√≥n / Empaste</a></li>
      <li><a href="../catalogacion/catalogacion.html">Catalogaciones</a></li>
      <li><a href="../entrega/entrega.html">Entrega Final</a></li>
      <li><a href="../digitalizacion/digitalizacion.html">Digitalizaci√≥n</a></li>
      <li class="active"><a href="../calidad/calidad.html">Control de Calidad</a></li>
      <li><a href="../terminado/terminado.html">Terminado Final</a></li>
      <li><a href="../alistamiento/alistamiento.html">Alistamiento</a></li>

      <div class="section-title"><b>Seguimiento ‚ñø</b></div>
      <li><a href="../control-procesos/procesos.html">Control de Procesos</a></li>
      <li><a href="../historial-procesos/historial-proceso.html">Historial de Procesos</a></li>
      <li><a href="../historial-tiempo.html">Historial de Tiempos</a></li>

      <div class="section-title"><b>Configuraci√≥n ‚ñø</b></div>
      <li><a href="../configuracion/permisos.html">Permisos</a></li>
      <li><a href="../configuracion/fases.html">Fases del Proceso</a></li>
      <li><a href="../configuracion/roles.html">Roles y Permisos</a></li>
      <li><a href="../configuracion/usuarios.html">Usuarios</a></li>

      <div class="section-title"><b>Gesti√≥n ‚ñø</b></div>
      <li><a href="../gestion/proveedores.html">Proveedores</a></li>
    </ul>
  </div>

  <!-- CONTENIDO -->
  <div class="content">
    <div class="header">
      <h2>üìë Control de Calidad</h2>
    </div>

    <!-- Contenedor din√°mico -->
    <div id="ordenes-container"></div>
  </div>

  <!-- Scripts -->
  <script src="../assets/js/flujo.js"></script>
  <script src="../assets/js/time-tracking.js"></script>

  <script>
    function toggleOrder(id) {
      const elem = document.getElementById(id);
      if (elem) elem.classList.toggle("hidden");
    }

    const container = document.getElementById("ordenes-container");
    const procesosPorOrden = {};

    // Agrupar procesos por orden (solo fase Calidad)
    Object.keys(localStorage).forEach(k => {
      if (!k.startsWith("proceso_")) return;
      const p = JSON.parse(localStorage.getItem(k));
      if (p.fase !== "calidad") return;
      if (!procesosPorOrden[p.orden]) procesosPorOrden[p.orden] = [];
      procesosPorOrden[p.orden].push(p);
    });

    // Renderizar
    Object.keys(procesosPorOrden).forEach((orden, idx) => {
      const blockId = `order-calidad-${idx}`;
      const procesos = procesosPorOrden[orden];

      const block = document.createElement("div");
      block.classList.add("order-block");
      block.innerHTML = `
        <button class="order-header" onclick="toggleOrder('${blockId}')">
          N√∫mero de Orden: ${orden} <span class="arrow">‚ñº</span>
        </button>

        <div id="${blockId}" class="order-content hidden">
          <table class="process-table">
            <thead>
              <tr>
                <th>ISBN</th>
                <th>T√≠tulo</th>
                <th>Cantidad</th>
                <th>Tiempo</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              ${procesos.map(p => `
                <tr data-url="detalle-calidad.html?id=${p.id}">
                  <td>${p.isbn || "-"}</td>
                  <td>${p.titulo}</td>
                  <td>${p.cantidad || 1}</td>
                  <td class="time-cell">
                    <div class="time-display" id="tt-time-${p.id}">${TT.getDisplay(p.id)}</div>
                    <small class="time-info"> Sesiones: ${TT.getSessionsCount(p.id)}</small>
                    <div class="time-btns">
                      <button class="btn-start" data-tt="start" data-id="${p.id}" data-fase="calidad">‚ñ∂</button>
                      <button class="btn-pause" data-tt="pause" data-id="${p.id}">‚è∏</button>
                      <button class="btn-save" data-tt="save" data-id="${p.id}">üíæ</button>
                    </div>
                    <div class="progress-bar"><div id="progress-${p.id}" class="progress-inner"></div></div>
                  </td>
                  <td>
                    <button class="btn" onclick="window.location.href='editar-calidad.html?id=${p.id}'">Editar</button>
                    <button class="btn red" onclick="FLUJO.eliminar('${p.id}')">Eliminar</button>
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;
      container.appendChild(block);
    });

    // Ir al detalle al hacer clic en fila
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll("tr[data-url]").forEach(row => {
        row.addEventListener("click", (e) => {
          if (e.target.tagName.toLowerCase() === "button") return;
          window.location.href = row.dataset.url;
        });
      });
      TT.initTicker();
    });

    // === Listener de botones de tiempo ===
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const action = btn.dataset.tt;
      if (!action) return;

      const id = btn.dataset.id;
      const fase = btn.dataset.fase;
      const user = "Admin A";

      if (action === "start") TT.start(id, fase, user);
      if (action === "pause") TT.pause(id);
      if (action === "save") {
        TT.saveLog(id);
        detenerTiempo(id); // acumula en historial
        alert("‚è± Tiempo guardado correctamente.");
      }
    });
  </script>
</body>
</html>
