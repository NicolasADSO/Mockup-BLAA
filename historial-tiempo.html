<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial de Tiempos - BlaaFlow</title>
  <link rel="stylesheet" href="assets/css/layout.css">
  <link rel="stylesheet" href="assets/css/control-procesos/procesos.css">
  <link rel="stylesheet" href="assets/css/historial-tiempo.css">
</head>

<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <img src="./assets/img/logo-sin-fondo.png" alt="Logo BlaaFlow">
    <div class="search-profile">
      <input type="text" placeholder="Buscar...">
      <div class="profile">A</div>
    </div>
  </div>

    <!-- SIDEBAR -->
  <div class="sidebar">
    <ul>
      <li><a href="./dashboard.html">Dashboard Admin</a></li>

      <div class="section-title"><b>Fases Especializadas ‚ñø</b></div>
      <li><a href="./empaste/empaste.html">Encuadernaci√≥n / Empaste</a></li>
      <li><a href="./catalogacion/catalogacion.html">Catalogaciones</a></li>
      <li ><a href="./entrega/entrega.html">Entrega Final</a></li>
      <li><a href="./digitalizacion/digitalizacion.html">Digitalizaci√≥n</a></li>
      <li><a href="./calidad/calidad.html">Control de Calidad</a></li>
      <li><a href="./terminado/terminado.html">Terminado Final</a></li>
      <li><a href="./alistamiento/alistamiento.html">Alistamiento</a></li>

      <div class="section-title"><b>Seguimiento ‚ñø</b></div>
      <li><a href="./control-procesos/procesos.html">Control de Procesos</a></li>
      <li><a href="./historial-procesos/historial-proceso.html">Historial de Procesos</a></li>
      <li class="active"><a href="./historial-tiempo.html">Historial de Tiempos</a></li>
      
      <div class="section-title"><b>Configuraci√≥n ‚ñø</b></div>
      <li><a href="./configuracion/permisos.html">Permisos</a></li>
      <li><a href="./configuracion/fases.html">Fases del Proceso</a></li>
      <li><a href="./configuracion/roles.html">Roles y Permisos</a></li>
      <li><a href="./configuracion/usuarios.html">Usuarios</a></li>

      <div class="section-title"><b>Gesti√≥n ‚ñø</b></div>
      <li><a href="./gestion/proveedores.html">Proveedores</a></li>
    </ul>
  </div>

  <!-- CONTENIDO -->
  <div class="content">
    <div class="header">
      <h2>üìö Historial de Tiempos</h2>
    </div>
    <div id="historial-container"></div>
  </div>

  <!-- Scripts -->
  <script src="../assets/js/flujo.js"></script>
  <script src="../assets/js/time-tracking.js?v=1"></script>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  const container = document.getElementById("historial-container");
  const historial = JSON.parse(localStorage.getItem("historial_procesos") || "[]");

  if (historial.length === 0) {
    container.innerHTML = `<p style="text-align:center; color:#777;">No hay √≥rdenes finalizadas en el historial.</p>`;
    return;
  }

  historial.forEach((registro, idx) => {
    const ordenId = `orden-hist-${idx}`;
    const procesos = registro.procesos || [];

    // Calcular tiempo total de la orden
    let totalSegundos = 0;
    procesos.forEach(p => {
      const tracking = JSON.parse(localStorage.getItem("timeTracking")) || {};
      const entry = tracking[p.id];
      if (entry) totalSegundos += entry.totalSegundos || 0;
    });
    const totalDisplay = formatTime(totalSegundos);

    // Crear bloque de la orden
    const block = document.createElement("div");
    block.classList.add("order-block");
    block.innerHTML = `
      <button class="order-header" onclick="toggleOrder('${ordenId}')">
        Orden ${registro.orden} ‚Äî ${registro.fechaFinalizacion}
        <span style="float:right;">(${registro.cantidadProcesos} procesos)</span>
      </button>

      <div id="${ordenId}" class="order-content hidden">
        <div class="order-info"><b>Tiempo Total Acumulado:</b> ${totalDisplay}</div>

        <div class="table-scroll">
          <table class="process-table">
            <thead>
              <tr>
                <th>T√≠tulo</th>
                <th>Fase Final</th>
                <th>Tiempo Total</th>
                <th>Sesiones</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              ${procesos.map((p, i) => {
                const tracking = JSON.parse(localStorage.getItem("timeTracking")) || {};
                const entry = tracking[p.id];
                const tiempo = entry ? formatTime(entry.totalSegundos) : "‚Äî";
                const sesiones = entry?.sesiones?.length || 0;
                const fases = entry?.fases || {};

                return `
                  <tr>
                    <td>${p.titulo || "‚Äî"}</td>
                    <td>${p.fase || p.estado || "‚Äî"}</td>
                    <td class="time-cell">${tiempo}</td>
                    <td class="time-detail">${sesiones} sesiones</td>
                    <td>
                      <button class="btn small" onclick="toggleFases('${ordenId}-${i}', this)">
                        <span class="icon">‚ñ∂</span> Ver detalle
                      </button>
                    </td>
                  <tr id="${ordenId}-${i}" class="fase-detalle hidden">
                    <td colspan="5">
                      <table class="subtable">
                        <thead>
                          <tr>
                            <th>Fase</th>
                            <th>Duraci√≥n</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${Object.keys(fases).length
                            ? Object.entries(fases).map(([fase, segundos]) => `
                                <tr>
                                  <td>${fase}</td>
                                  <td>${formatTime(segundos)}</td>
                                </tr>
                              `).join("")
                            : `<tr><td colspan="2">Sin detalle por fase</td></tr>`}
                        </tbody>
                      </table>
                    </td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        </div>
      </div>
    `;
    container.appendChild(block);
  });
});

function toggleOrder(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle("hidden");
}

function toggleFases(id, btn) {
  const el = document.getElementById(id);
  if (!el || !btn) return;

  // Alternar visibilidad del detalle
  el.classList.toggle("hidden");

  // Alternar clase activa en el bot√≥n
  btn.classList.toggle("active");

  // Cambiar texto e √≠cono din√°micamente
  const icon = btn.querySelector(".icon");
  const text = btn.childNodes[btn.childNodes.length - 1];

  if (btn.classList.contains("active")) {
    if (icon) icon.textContent = "‚ñº";
    if (text) btn.innerHTML = '<span class="icon">‚ñº</span> Ocultar detalle';
  } else {
    if (icon) icon.textContent = "‚ñ∂";
    if (text) btn.innerHTML = '<span class="icon">‚ñ∂</span> Ver detalle';
  }
}

function formatTime(sec) {
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  return `${h}h ${m}m ${s}s`;
}
</script>

</body>
</html>
