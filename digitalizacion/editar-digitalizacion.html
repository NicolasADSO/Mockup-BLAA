<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editar Proceso - Digitalizaci√≥n</title>
  <link rel="stylesheet" href="../assets/css/layout.css">
  <link rel="stylesheet" href="../assets/css/editar.css">
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <img src="../assets/img/logo-sin-fondo.png" alt="Logo BlaaFlow">
    <div class="search-profile">
      <input type="text" placeholder="Buscar...">
      <div class="profile">A</div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <ul>
      <li><a href="../dashboard.html">Dashboard Admin</a></li>

      <div class="section-title"><b>Fases Especializadas ‚ñø</b></div>
      <li><a href="../empaste/empaste.html">Encuadernaci√≥n / Empaste</a></li>
      <li><a href="../catalogacion/catalogacion.html">Catalogaciones</a></li>
      <li><a href="../entrega/entrega.html">Entrega Final</a></li>
      <li><a href="../digitalizacion/digitalizacion.html" class="active">Digitalizaci√≥n</a></li>
      <li><a href="../calidad/calidad.html">Control de Calidad</a></li>
      <li><a href="../terminado/terminado.html">Terminado Final</a></li>
      <li><a href="../alistamiento/alistamiento.html">Alistamiento</a></li>

      <div class="section-title"><b>Seguimiento ‚ñø</b></div>
      <li><a href="../control-procesos/procesos.html">Control de Procesos</a></li>
      <li><a href="../historial-procesos/historial-proceso.html">Historial de Procesos</a></li>
      <li><a href="../historial-tiempo.html">Historial de Tiempos</a></li>
      
      <div class="section-title"><b>Configuraci√≥n ‚ñø</b></div>
      <li><a href="../configuracion/permisos.html">Permisos</a></li>
      <li><a href="../configuracion/fases.html">Fases del Proceso</a></li>
      <li><a href="../configuracion/roles.html">Roles y Permisos</a></li>
      <li><a href="../configuracion/usuarios.html">Usuarios</a></li>

      <div class="section-title"><b>Gesti√≥n ‚ñø</b></div>
      <li><a href="../gestion/proveedores.html">Proveedores</a></li>
    </ul>
  </div>

  <!-- CONTENIDO -->
  <div class="content">
    <h2 class="page-title">‚úèÔ∏è Editar Proceso - Digitalizaci√≥n</h2>

    <div class="edit-card edit-form">
      <h3 class="section-title">Informaci√≥n de Digitalizaci√≥n</h3>

      <form id="form-digitalizacion">
        <div class="field">
          <label>Operador:</label>
          <input type="text" name="operador" placeholder="Nombre del operador">
        </div>

        <div class="field">
          <label>Fecha de Digitalizaci√≥n:</label>
          <input type="date" name="fecha_digitalizacion">
        </div>

        <div class="field">
          <label>Formato:</label>
          <select name="formato">
            <option value="pdf">PDF</option>
            <option value="jpg">JPG</option>
            <option value="tiff">TIFF</option>
          </select>
        </div>

        <div class="field">
          <label>Resoluci√≥n (dpi):</label>
          <input type="number" name="resolucion" placeholder="300">
        </div>

        <div class="form-footer two-cols">
          <a href="../digitalizacion/digitalizacion.html" class="btn ghost">Volver al listado</a>
          <button type="submit" class="btn" id="guardarBtn">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../assets/js/flujo.js"></script>
  <script src="../assets/js/time-tracking.js?v=1"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const id = FLUJO.readId();
      const proceso = JSON.parse(localStorage.getItem(`proceso_${id}`));
      if (!id || !proceso) return;

      const user = "Admin A"; // reemplazar con usuario actual del sistema
      const faseActual = "alistamiento"; // siempre se fija la fase actual

      // === üîπ INICIAR AUTOM√ÅTICAMENTE EL TIEMPO ===
      TT.start(id, faseActual, user);
      console.log("‚è±Ô∏è Contador iniciado autom√°ticamente para", faseActual);

      // === üîπ GUARDAR TIEMPO AUTOM√ÅTICO AL SALIR O RECARGAR ===
      window.addEventListener("beforeunload", () => {
        const map = JSON.parse(localStorage.getItem("time_tracking") || "{}");
        const st = map[id];
        if (st && st.running) {
          TT.pause(id);
          TT.saveLog(id);
          console.log("üíæ Tiempo guardado autom√°ticamente antes de salir.");
        }
      });

      // === üîπ GUARDAR FORMULARIO MANUALMENTE ===
      const form = document.getElementById("form-alistamiento");
      form.addEventListener("submit", function (e) {
        e.preventDefault();

        // Pausa y guarda definitivamente el tiempo de esta fase
        TT.pause(id);
        TT.saveLog(id);

        const datos = {
          materiales: this.materiales.value,
          fecha_inicio: this.fecha_inicio.value,
        };

        // Guardar datos en la fase actual
        FLUJO.guardarFase(id, faseActual, datos);

        // Avanzar a la siguiente fase (detalle o listado)
        FLUJO.goDetalleSiguiente(id);
      });
    });
  </script>

</body>
</html>
