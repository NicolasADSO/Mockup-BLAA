<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Procesos - BlaaFlow</title>
  <link rel="stylesheet" href="../assets/css/layout.css">
  <link rel="stylesheet" href="../assets/css/control-procesos/procesos.css">
  <style>

    /* === SCROLL HORIZONTAL PARA TABLAS GRANDES === */
    .table-scroll {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table-scroll::-webkit-scrollbar {
      height: 8px;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.3);
      border-radius: 4px;
    }
    .table-scroll::-webkit-scrollbar-track {
      background-color: transparent;
    }

    .process-table {
      min-width: 1000px; /* aseg√∫rate de que no se aplaste */
      border-collapse: collapse;
    }

    .process-table th, 
    .process-table td {
      white-space: nowrap; /* evita que las celdas salten de l√≠nea */
    }


    .time-display {
      font-weight: 600;
      color: #222;
      text-align: center;
    }
    .time-cell {
      text-align: center;
      min-width: 130px;
    }
    .time-detail {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <img src="../assets/img/logo-sin-fondo.png" alt="Logo BlaaFlow">
    <div class="search-profile">
      <input type="text" placeholder="Buscar...">
      <div class="profile">A</div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <ul>
      <li><a href="../dashboard.html">Dashboard Admin</a></li>

      <div class="section-title"><b>Fases Especializadas ‚ñø</b></div>
      <li><a href="../empaste/empaste.html">Encuadernaci√≥n / Empaste</a></li>
      <li><a href="../catalogacion/catalogacion.html">Catalogaciones</a></li>
      <li><a href="../entrega/entrega.html">Entrega Final</a></li>
      <li><a href="../digitalizacion/digitalizacion.html">Digitalizaci√≥n</a></li>
      <li><a href="../calidad/calidad.html">Control de Calidad</a></li>
      <li><a href="../terminado/terminado.html">Terminado Final</a></li>
      <li><a href="../alistamiento/alistamiento.html">Alistamiento</a></li>

      <div class="section-title"><b>Seguimiento ‚ñø</b></div>
      <li class="active"><a href="../control-procesos/procesos.html">Control de Procesos</a></li>
      <li><a href="../historial-procesos/historial-proceso.html">Historial de Procesos</a></li>
      <li><a href="../historial-tiempo.html">Historial de Tiempo</a></li>

      <div class="section-title"><b>Configuraci√≥n ‚ñø</b></div>
      <li><a href="../configuracion/permisos.html">Permisos</a></li>
      <li><a href="../configuracion/fases.html">Fases del Proceso</a></li>
      <li><a href="../configuracion/roles.html">Roles y Permisos</a></li>
      <li><a href="../configuracion/usuarios.html">Usuarios</a></li>

      <div class="section-title"><b>Gesti√≥n ‚ñø</b></div>
      <li><a href="../gestion/proveedores.html">Proveedores</a></li>
    </ul>
  </div>

  <!-- CONTENIDO -->
  <div class="content">
    <div class="header">
      <h2>üìë Control de Procesos</h2>
      <a href="nuevo-proceso.html" class="btn"> + Nuevo Proceso</a>
    </div>
    <div id="orders-container"></div>
  </div>

  

  <script>
    // === Agrupar procesos por orden ===
    function agruparPorOrden() {
      const procesos = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith("proceso_")) {
          procesos.push(JSON.parse(localStorage.getItem(key)));
        }
      }
      const grupos = {};
      procesos.forEach(p => {
        const orden = p.orden || "Sin Orden";
        if (!grupos[orden]) grupos[orden] = [];
        grupos[orden].push(p);
      });
      return grupos;
    }

    // === Obtener tiempo acumulado desde localStorage.timeTracking ===
    function getTiempoAcumulado(id) {
      const tracking = JSON.parse(localStorage.getItem("timeTracking")) || {};
      const registro = tracking[id];
      const segundos = registro ? registro.totalSegundos || 0 : 0;
      const horas = Math.floor(segundos / 3600);
      const minutos = Math.floor((segundos % 3600) / 60);
      const secs = segundos % 60;
      return `${horas}h ${minutos}m ${secs}s`;
    }

    // === Renderizar tabla de procesos ===
    function renderProcesos() {
      const container = document.getElementById("orders-container");
      container.innerHTML = "";

      const grupos = agruparPorOrden();

      Object.keys(grupos).forEach(orden => {
        const procesos = grupos[orden];
        const orderId = "order-" + orden.replace(/\s+/g, "_");
        const todosFinalizados = procesos.every(p => p.estado === "Finalizado");

        const block = document.createElement("div");
        block.classList.add("order-block");

        block.innerHTML = `
          <button class="order-header" onclick="toggleOrder('${orderId}')">
            N√∫mero de Orden: ${orden}
            <span class="count">(${procesos.length} procesos)</span>
            <span class="arrow">‚ñº</span>
          </button>

          ${todosFinalizados ? `
            <div class="export-section">
              <button class="btn btn-pdf" onclick="exportarOrden('${orden}')">üìÑ Exportar Acta Consolidada</button>
              <button class="btn green" onclick="finalizarOrden('${orden}')">‚úÖ Finalizar Orden</button>
            </div>
          ` : ""}

          <div id="${orderId}" class="order-content hidden">
            <div class="table-scroll">
            <table class="process-table">
              <thead>
                <tr>
                  <th>T√≠tulo</th>
                  <th>ISBN</th>
                  <th>Cantidad</th>
                  <th>Valor</th>
                  <th>Estado / Fase</th>
                  <th>Tiempo Acumulado</th>
                  <th>Fecha Finalizaci√≥n</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                ${procesos.map(p => {
                  const estado = p.estado || p.fase || "-";
                  let badgeClass = "badge red";
                  if (estado === "Finalizado") badgeClass = "badge green";
                  else if (estado === "entrega") badgeClass = "badge yellow";

                  const tiempoTotal = getTiempoAcumulado(p.id);

                  return `
                    <tr>
                      <td>${p.titulo || "‚Äî"}</td>
                      <td>${p.isbn || "‚Äî"}</td>
                      <td>${p.cantidad || 1}</td>
                      <td>${p.valor || "-"}</td>
                      <td><span class="${badgeClass}">${estado}</span></td>
                      <td class="time-cell">
                        <div class="time-display">${tiempoTotal}</div>
                        <div class="time-detail">(${(JSON.parse(localStorage.getItem("timeTracking"))?.[p.id]?.sesiones?.length || 0)} sesiones)</div>
                      </td>
                      <td>${p.fechaFinalizacion || "-"}</td>
                      <td>
                        ${p.estado === "Finalizado"
                          ? `<button class="btn btn-pdf" data-id="${p.id}">üìÑ Acta PDF</button>`
                          : `
                            <button class="btn" onclick="FLUJO.goDetalleActual('${p.id}')">Ver</button>
                            <button class="btn blue" onclick="FLUJO.avanzar('${p.id}')">Siguiente</button>
                            <button class="btn red" onclick="FLUJO.eliminar('${p.id}')">Eliminar</button>
                          `}
                      </td>
                    </tr>
                  `;
                }).join("")}
              </tbody>
            </table>
            </div>
          </div>
        `;
        container.appendChild(block);
      });
    }

    // === Mostrar / ocultar bloques ===
    function toggleOrder(id) {
      const content = document.getElementById(id);
      if (content) content.classList.toggle("hidden");
    }

    // === Exportar Acta Consolidada de una Orden ===
    function exportarOrden(orden) {
      const procesos = Object.keys(localStorage)
        .filter(k => k.startsWith("proceso_"))
        .map(k => JSON.parse(localStorage.getItem(k)))
        .filter(p => p.orden === orden);

      if (procesos.length === 0) {
        alert("‚ùå No hay procesos para esta orden.");
        return;
      }

      if (typeof generarActaConsolidada === "function") {
        generarActaConsolidada(orden, procesos);
      }
    }

    // === Finalizar una Orden ===
    function finalizarOrden(orden) {
      if (!confirm(`¬øDeseas finalizar la orden ${orden}? Esta acci√≥n mover√° todos sus procesos al historial.`)) return;

      const todasLasClaves = Object.keys(localStorage).filter(k => k.startsWith("proceso_"));
      const todosProcesos = todasLasClaves.map(k => JSON.parse(localStorage.getItem(k)));

      const procesosDeOrden = todosProcesos.filter(p => p.orden === orden);
      const historial = JSON.parse(localStorage.getItem("historial_procesos") || "[]");

      const nuevoRegistro = {
        orden,
        fechaFinalizacion: new Date().toLocaleDateString("es-CO"),
        cantidadProcesos: procesosDeOrden.length,
        procesos: procesosDeOrden
      };

      historial.push(nuevoRegistro);
      localStorage.setItem("historial_procesos", JSON.stringify(historial));

      procesosDeOrden.forEach(p => {
        TT.saveLog(p.id);
        TT.remove(p.id);
        localStorage.removeItem(`proceso_${p.id}`);
      });

      alert(`‚úÖ La orden ${orden} fue finalizada y movida al historial.`);
      renderProcesos();
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderProcesos();
    });

    // === Eventos para generar Acta PDF individual ===
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("btn-pdf") && e.target.dataset.id) {
        const id = e.target.dataset.id;
        const proceso = JSON.parse(localStorage.getItem(`proceso_${id}`));

        if (!proceso) {
          alert("‚ùå No se encontr√≥ informaci√≥n del proceso.");
          return;
        }

        if (typeof generarActaPDF === "function") {
          generarActaPDF(proceso);
        } else {
          alert("‚ö†Ô∏è La funci√≥n generarActaPDF no est√° disponible.");
        }
      }
    });
  </script>

  <!-- Librer√≠as necesarias -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- Scripts principales -->
  <script src="../assets/js/flujo.js"></script>
  <script src="../assets/js/time-tracking.js?v=1"></script>

  <!-- Scripts modulares -->
  <script src="../assets/js/acta-pdf.js?v=5"></script>
  <script src="../assets/js/acta-orden.js?v=1"></script>
</body>
</html>
