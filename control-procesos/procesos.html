<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Procesos - BlaaFlow</title>
  <link rel="stylesheet" href="../assets/css/layout.css">
  <link rel="stylesheet" href="../assets/css/control-procesos/procesos.css">
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <img src="../assets/img/logo-sin-fondo.png" alt="Logo BlaaFlow">
    <div class="search-profile">
      <input type="text" placeholder="Buscar...">
      <div class="profile">A</div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <ul>
      <li>
        <a href="../dashboard.html">Dashboard Admin</a>
      </li>
      <div class="section-title"><b>Fases Especializadas ‚ñø</b></div>
      <li><a href="../empaste/empaste.html">Encuadernaci√≥n</a></li>
      <li><a href="../catalogacion/catalogacion.html">Catalogaciones</a></li>
      <li><a href="../entrega/entrega.html">Entrega Final</a></li>
      <li><a href="../digitalizacion/digitalizacion.html">Digitalizaci√≥n</a></li>
      <li><a href="../calidad/calidad.html">Control de Calidad</a></li>
      <li><a href="../terminado/terminado.html">Terminado Final</a></li>
      <li><a href="../alistamiento/alistamiento.html">Alistamiento</a></li>
      <div class="section-title"><b>Seguimiento ‚ñø</b></div>
      <li class="active"><a href="../control-procesos/procesos.html">Control de Procesos</a></li>
    </ul>
  </div>

  <!-- CONTENIDO -->
  <div class="content">
    <div class="header">
      <h2>üìë Control de Procesos</h2>
      <a href="nuevo-proceso.html" class="btn"> + Nuevo Proceso</a>
    </div>

    <!-- Contenedor din√°mico -->
    <div id="orders-container"></div>
  </div> 

  <!-- Scripts -->
  <script src="../assets/js/flujo.js"></script>
  <script>
    // Funci√≥n para agrupar procesos por n√∫mero de orden
    function agruparPorOrden() {
      const procesos = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith("proceso_")) {
          procesos.push(JSON.parse(localStorage.getItem(key)));
        }
      }

      // Agrupar por numero de orden
      const grupos = {};
      procesos.forEach(p => {
        if (!grupos[p.orden]) grupos[p.orden] = [];
        grupos[p.orden].push(p);
      });
      return grupos;
    }

    function renderProcesos() {
      const container = document.getElementById("orders-container");
      container.innerHTML = "";

      const grupos = agruparPorOrden();

      Object.keys(grupos).forEach(orden => {
        const procesos = grupos[orden];
        const orderId = "order-" + orden;

        const block = document.createElement("div");
        block.classList.add("order-block");
        block.innerHTML = `
          <button class="order-header" onclick="toggleOrder('${orderId}')">
            N√∫mero de Orden: ${orden} <span class="arrow">‚ñº</span>
          </button>
          <div id="${orderId}" class="order-content hidden">
            <table class="process-table">
              <thead>
                <tr>
                  <th>T√≠tulo</th>
                  <th>ISBN</th>
                  <th>Cantidad</th>
                  <th>Valor</th>
                  <th>Fase</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                ${procesos.map(p => `
                  <tr>
                    <td>${p.titulo}</td>
                    <td>${p.isbn || "-"}</td>
                    <td>${p.cantidad}</td>
                    <td>${p.valor || "-"}</td>
                    <td>${p.fase}</td>
                    <td>
                      <button class="btn" onclick="FLUJO.goDetalleActual('${p.id}')">Ver</button>
                      <button class="btn" onclick="FLUJO.avanzar('${p.id}')">Siguiente</button>
                      <button class="btn red" onclick="FLUJO.eliminar('${p.id}')">Eliminar</button>
                    </td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        `;
        container.appendChild(block);
      });
    }

    // Funci√≥n para desplegar/plegar bloques
    function toggleOrder(id) {
      const content = document.getElementById(id);
      if (content) content.classList.toggle("hidden");
    }

    document.addEventListener("DOMContentLoaded", renderProcesos);
  </script>
</body>
</html>
