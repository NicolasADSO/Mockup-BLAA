<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detalle de Entrega Final - BlaaFlow</title>
  <link rel="stylesheet" href="../assets/css/layout.css">
  <link rel="stylesheet" href="../assets/css/detalle.css">
  <link rel="stylesheet" href="../assets/css/entrega/entrega.css"> 
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <img src="../assets/img/logo-sin-fondo.png" alt="Logo BlaaFlow">
    <div class="search-profile">
      <input type="text" placeholder="Buscar...">
      <div class="profile">A</div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <ul>
      <li><a href="../dashboard.html">Dashboard Admin</a></li>

      <div class="section-title"><b>Fases Especializadas ‚ñø</b></div>
      <li><a href="../empaste/empaste.html">Encuadernaci√≥n / Empaste</a></li>
      <li><a href="../catalogacion/catalogacion.html">Catalogaciones</a></li>
      <li><a href="../entrega/entrega.html" class="active">Entrega Final</a></li>
      <li><a href="../digitalizacion/digitalizacion.html">Digitalizaci√≥n</a></li>
      <li><a href="../calidad/calidad.html">Control de Calidad</a></li>
      <li><a href="../terminado/terminado.html">Terminado Final</a></li>
      <li><a href="../alistamiento/alistamiento.html">Alistamiento</a></li>

      <div class="section-title"><b>Seguimiento ‚ñø</b></div>
      <li><a href="../control-procesos/procesos.html">Control de Procesos</a></li>
      <li><a href="../historial-procesos/historial.html">Historial de Procesos</a></li>


      <div class="section-title"><b>Configuraci√≥n ‚ñø</b></div>
      <li><a href="../configuracion/permisos.html">Permisos</a></li>
      <li><a href="../configuracion/fases.html">Fases del Proceso</a></li>
      <li><a href="../configuracion/roles.html">Roles y Permisos</a></li>
      <li><a href="../configuracion/usuarios.html">Usuarios</a></li>

      <div class="section-title"><b>Gesti√≥n ‚ñø</b></div>
      <li><a href="../gestion/proveedores.html">Proveedores</a></li>
    </ul>
  </div>

  <!-- CONTENIDO -->
  <div class="content">
    <h2>üìò Detalle de Entrega Final</h2>

    <!-- Botones principales -->
    <div class="actions">
      <button class="btn" onclick="window.location.href='editar-entrega.html'">Editar</button>
      <button class="btn red" onclick="FLUJO.eliminar(FLUJO.readId())">Eliminar</button>
      <button id="guardarEntregaBtn" class="btn success">Guardar Entrega</button>
      <button id="finalizarBtn" class="btn green">Finalizar Proceso</button>
      <button class="btn">Exportar Excel</button>
      <button class="btn">Exportar PDF</button>
    </div>

    <!-- INFO CARD GENERAL -->
    <div class="info-card">
      <p><b>T√≠tulo:</b> <span id="titulo">Literatura Universal</span></p>
      <p><b>ISBN:</b> <span id="isbn">9789589876543</span></p>
      <p><b>Cantidad:</b> <span id="cantidad">2</span></p>
      <p><b>Total l√≠nea:</b> <span id="total">$80,000</span></p>
      <p><b>Estado:</b> <span id="estado">Pendiente de Entrega</span></p>
      <p><b>Fase actual:</b> <span id="fase">Entrega Final</span></p>
      <p><b>N√∫mero de Orden:</b> <span id="orden">ENT-2025-01</span></p>
    </div>

    <!-- FORMULARIO DE ENTREGA -->
    <div class="form-section">
      <h3>üìë Informaci√≥n de Entrega Final</h3>
      <form id="formEntrega">
        <div>
          <label>Fecha de Entrega:</label>
          <input type="date" name="fechaEntrega" value="2025-09-25">
        </div>
        <div>
          <label>Responsable de Entrega:</label>
          <input type="text" name="responsable" value="Mar√≠a Gonz√°lez">
        </div>
        <div style="grid-column: span 2;">
          <label>Observaciones:</label>
          <textarea name="observaciones">Los libros se entregaron en perfecto estado con acta firmada.</textarea>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../assets/js/eliminar.js"></script>
  <script src="../assets/js/flujo.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      FLUJO.hidratarDetalle();

      const id = FLUJO.readId?.();
      if (!id) return;

      const form = document.getElementById("formEntrega");
      const btnGuardar = document.getElementById("guardarEntregaBtn");
      const btnFinalizar = document.getElementById("finalizarBtn");

      // ‚úÖ Guardar Entrega
      if (btnGuardar && form) {
        btnGuardar.addEventListener("click", (e) => {
          e.preventDefault();

          const datos = {
            fechaEntrega: form.querySelector("input[name='fechaEntrega']").value,
            responsable: form.querySelector("input[name='responsable']").value.trim(),
            observaciones: form.querySelector("textarea[name='observaciones']").value.trim(),
            fechaRegistro: new Date().toISOString().slice(0, 10)
          };

          FLUJO.guardarFase(id, "entrega", datos);
          alert("‚úÖ Datos de Entrega Final guardados correctamente.");
        });
      }

      // ‚úÖ Finalizar Proceso
      if (btnFinalizar) {
        btnFinalizar.addEventListener("click", () => {
          const confirmar = confirm("¬øDeseas marcar este proceso como FINALIZADO?");
          if (!confirmar) return;

          const proceso = FLUJO.get(id);
          if (!proceso) {
            alert("‚ùå No se encontr√≥ el proceso.");
            return;
          }

          proceso.estado = "Finalizado";
          proceso.fechaFinalizacion = new Date().toISOString().slice(0, 10);
          FLUJO.set(proceso);

          alert("üéâ Proceso finalizado con √©xito.");
          window.location.href = "../control-procesos/procesos.html";
        });
      }
    });
  </script>
</body>
</html>
